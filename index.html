<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Atelier Project map using CraftCMS feed</title>
	<link rel="stylesheet" type="text/css" href="css/main.css" />
</head>
<body>
	<div id="wrapper">
		<div id="controls" class="slide-out"></div>
		<div id="map" class="slide-out"></div>
	</div>	

	<!-- Scripts -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAk7Z0k1M3kL8Df_s7bBH0_ucqTadiVQqc"></script>
	<script type="text/javascript" src="js/convex-hull.js"></script>
	<script type="text/javascript" src="js/markerclusterer.js"></script>
	<script type="text/javascript" src="js/project-map.js"></script>
	<script type="text/javascript">
    	/* Let the show begin... */

		$(document).ready(function(){
			
			/* Initiate the map */
			projectMap.init( $('#map').get(0), 'en' );

			/* Load, store and process projects- */
			var projects = function(){
				return projectMap.getAllProjects();//.then(projectMap.setProjects);
			};

			/* ...themes... */
			var themes = function(){
				return projectMap.getAllThemes();//.then(projectMap.setThemes);
			};

			/* ...and people */
			var people = function(){
				return projectMap.getAllPeople();//.then(projectMap.setPeople);
			};


			$.when(
				projectMap.getAllProjects(),
				projectMap.getAllThemes(),
				projectMap.getAllPeople()
			)
			.done(function(projects, themes, people){
				
				console.log(projects[0].data);

				projectMap.setProjects( projects[0].data.slice() );
				projectMap.setThemes( themes[0].data.slice() );
				projectMap.setPeople( people[0].data.slice() );

				var mapDropDown = projectMap.createProjectDropdown(projectMap.getProjects(), 'project-picker');
				
				mapDropDown.on('change', function(e){
					
					/* Close any info bubble that may be open */
					projectMap.closeBubble();

					if( $(this).val() == 9999 ){
											
						/*Hide the sidebar when 'all projects' are selected*/
						$('#controls').removeClass('slide-in').addClass('slide-out');
						$('#map').removeClass('slide-in').addClass('slide-out');

						google.maps.event.trigger(projectMap.getMap(), 'resize');

						projectMap.displayAllProjects(true);
						
						return;
					}

					/* Get single project's details and prepare request for retrieving participants */
					
					//var project = projectMap.getSingleProject( $(this).val() );

			        var clusterer = projectMap.getClusterer();

			        if( typeof clusterer != 'undefined' ){
			        	clusterer.clearMarkers();
			        	clusterer = null;
			        }

					var project = projectMap.getProjectByID( $(this).val() );

        			$('#controls')
        				.html('')
        				.css({'background': project.themeColor.replace(/-/g, "")});

        			var lbl = $('<label>').css({'padding':'15px','border':'1px solid #000000', 'display': 'block', 'margin-top': '80px', 'font-size': '14px'}).html(projectMap.getThemeInfo(project.themeID).title);

        			$('#controls').append(lbl);
        			$('#controls').append('<h1>' + project.title + '</h1>');
        			$('#controls').append(project.intro);
        			$('#controls').append('<a href="' + project.url + '">View project</a>');

        			$('#map').removeClass('slide-out').addClass('slide-in');
        			$('#controls').removeClass('slide-out').addClass('slide-in');
        			
					google.maps.event.trigger(projectMap.getMap(), 'resize');

					var projectMapState = projectMap.displayProjectPeople( $(this).val() );

	        		/*if(!projectMapState.bounds.isEmpty()){
	        			projectMap.getMap().fitBounds( projectMapState.bounds );	        			
	        		}*/        									
				});

				/* Update the dropdown with the perpared SELECT HTML markup */
				projectMap.updateMapDropdown(mapDropDown);

				projectMap.displayAllProjects(false);

				projectMap.getMap().setCenter( new google.maps.LatLng(43.6766, 4.6278) );				
				projectMap.getMap().setZoom(12);

			});
		});
	</script>
</body>
</html>